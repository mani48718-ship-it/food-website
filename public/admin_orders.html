<!DOCTYPE html>
<html>
<head>
<title>Admin Orders</title>
<style>
body{font-family:Arial;background:#f5f5f5;margin:0;padding:20px;}
.card{
background:white;
padding:15px;
margin:15px 0;
border-radius:10px;
box-shadow:0 0 10px #ccc;
}
button{
padding:6px 10px;
margin:3px;
border:none;
border-radius:5px;
cursor:pointer;
background:#ff4d4d;
color:white;
}
</style>
</head>
<body>

<h2>ðŸ“¦ Live Orders</h2>
<div id="orders">Loading...</div>


<script>

async function checkLogin(){
const res = await fetch("/admin/check");
const data = await res.json();


if(!data.loggedIn){
    window.location.href = "/login";
    return false;
}
return true;


}

function formatDate(time){
    if(!time) return "Not delivered yet";
    const d = new Date(time);
    return d.toLocaleString();
}

async function loadOrders(){
    try{
        const res = await fetch(window.location.origin + "/admin/orders");
        const orders = await res.json();

        const div = document.getElementById("orders");
        div.innerHTML = "";

        if(!Array.isArray(orders)){
            div.innerHTML = "Server error loading orders";
            return;
        }

        orders.forEach(order=>{

            // hide completed orders from live screen
            if(order.status === "Delivered") return;

            const phone = order.phone || "â€”";
            const address = order.address || "â€”";
            const delivered = order.delivered_at ? formatDate(order.delivered_at) : "Not delivered yet";

            div.innerHTML += `
            <div class="card">
            <b>Order #${order.id}</b><br>
            Name: ${order.customer_name}<br>
            Phone: ${phone}<br>
            Address: ${address}<br>
            Items: ${order.food_item}<br>
            Total: â‚¹${order.total_price}<br>

            Status: <b id="status-${order.id}">${order.status}</b><br>
            Delivered Time: <b>${delivered}</b><br><br>

            <button onclick="updateStatus(${order.id},'Accepted')">Accept</button>
            <button onclick="updateStatus(${order.id},'Preparing')">Preparing</button>
            <button onclick="updateStatus(${order.id},'Out for Delivery')">Out</button>
            <button onclick="updateStatus(${order.id},'Delivered')">Delivered</button>
            <button onclick="deleteOrder(${order.id})" style="background:black">Delete</button>
            </div>
            `;
        });

        if(div.innerHTML === ""){
            div.innerHTML = "No active orders";
        }

    }catch(err){
        document.getElementById("orders").innerHTML = "Cannot connect to server";
        console.log(err);
    }
}

async function updateStatus(id,status){
    await fetch(window.location.origin + `/admin/update-status/${id}/${status}`,{
        method:"POST"
    });

    // reload immediately
    loadOrders();
}

async function deleteOrder(id){
    if(!confirm("Delete this order permanently?")) return;

    await fetch(window.location.origin + `/admin/delete-order/${id}`,{
        method:"DELETE"
    });

    loadOrders();
}

// auto refresh
setInterval(loadOrders,5000);
loadOrders();

</script>


</body>
</html>