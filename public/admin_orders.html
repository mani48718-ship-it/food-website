<!DOCTYPE html>

<html>
<head>
<title>Admin Orders</title>

<style>
body{font-family:Arial;background:#f5f5f5;margin:0;padding:20px;}
.card{
background:white;
padding:15px;
margin:15px 0;
border-radius:10px;
box-shadow:0 0 10px #ccc;
}
button{
padding:6px 10px;
margin:3px;
border:none;
border-radius:5px;
cursor:pointer;
background:#ff4d4d;
color:white;
}
</style>

</head>

<body>

<h2>ðŸ“¦ Live Orders</h2>
<div id="orders">Loading...</div>

<script>

const bell = new Audio("/bell.mp3");
let lastOrderId = 0;

function formatDate(time){
    if(!time) return "Not delivered yet";
    return new Date(time).toLocaleString();
}

async function loadOrders(){

    try{
        const res = await fetch("/admin/orders",{credentials:"include"});

        if(res.status===401 || res.redirected){
            window.location.href="/login";
            return;
        }

        const orders = await res.json();

        const div=document.getElementById("orders");
        div.innerHTML="";

        if(orders.length > 0){
    const newest = orders[0].id;

    if(lastOrderId !== 0 && newest > lastOrderId){
        bell.play();   // ðŸ”” NEW ORDER SOUND
    }

    lastOrderId = newest;
}

        orders.forEach(order=>{

            // hide delivered orders
            if(order.status==="Delivered") return;

            const delivered = formatDate(order.delivered_at);

            div.innerHTML += `
            <div class="card">
            <b>Order #${order.id}</b><br>
            Name: ${order.customer_name}<br>
            Phone: ${order.phone || "-"}<br>
            Address: ${order.address || "-"}<br>
            Items: ${order.food_item}<br>
            Total: â‚¹${order.total_price}<br>

            Status: <b id="status-${order.id}">${order.status}</b><br>
            Delivered Time: <b>${delivered}</b><br><br>

            <button onclick="updateStatus(${order.id},'Accepted')">Accept</button>
            <button onclick="updateStatus(${order.id},'Preparing')">Preparing</button>
            <button onclick="updateStatus(${order.id},'Out for Delivery')">Out</button>
            <button onclick="updateStatus(${order.id},'Delivered')">Delivered</button>
            <button onclick="deleteOrder(${order.id})" style="background:black">Delete</button>
            </div>`;
        });

    }catch(err){
        document.getElementById("orders").innerHTML="âš  Server sleeping... refresh in 10 seconds";
    }
}

async function updateStatus(id,status){
    await fetch(`/admin/update-status/${id}/${status}`,{
        method:"POST",
        credentials:"include"
    });
    loadOrders();
}

async function deleteOrder(id){

    if(!confirm("Delete this order permanently?")) return;

    await fetch(`/admin/delete-order/${id}`,{
        method:"DELETE",
        credentials:"include"
    });

    loadOrders();
}

setInterval(loadOrders,5000);
loadOrders();

</script>

</body>
</html>
