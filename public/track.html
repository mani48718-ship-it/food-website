<!DOCTYPE html>
<html>
<head>
    <title>Track Your Order</title>

    <!-- MAP FILES -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body{
            font-family: Arial;
            background:#f5f5f5;
            text-align:center;
            padding-top:60px;
        }

        .box{
            background:white;
            width:360px;
            margin:auto;
            padding:25px;
            border-radius:12px;
            box-shadow:0 0 12px rgba(0,0,0,0.2);
        }

        input{
            padding:10px;
            width:85%;
            margin:10px;
            border-radius:6px;
            border:1px solid #ccc;
        }

        button{
            padding:10px 18px;
            background:#ff4d4d;
            color:white;
            border:none;
            border-radius:6px;
            cursor:pointer;
        }

        button:hover{
            background:#e43b3b;
        }

        .stage{
            margin:10px 0;
            padding:10px;
            border-radius:8px;
            text-align:left;
        }

        .done{
            background:#d4edda;
            color:#155724;
            font-weight:bold;
        }

        .pending{
            background:#eeeeee;
            color:#777;
        }

        .title{
            margin-bottom:10px;
        }
        .card{
background:white;
width:320px;
margin:80px auto;
padding:25px;
border-radius:12px;
box-shadow:0 0 12px #ccc;
text-align:center;
}

.card input{
width:90%;
padding:10px;
border-radius:6px;
border:1px solid #ccc;
}

.card button{
background:#ff4d4d;
color:white;
padding:12px 18px;
border:none;
border-radius:8px;
cursor:pointer;
}

    </style>
</head>

<body>

<header class="topHeader">
<div style="color:rgb(238, 84, 84);font-weight:bold;">üçî SMK Restaurant</div>
<a href="/menu.html" class="trackBtn">üçΩ Back to Menu</a>
</header>

<div class="card">
<h2>üì¶ Track Your Order</h2>

<input id="phone" placeholder="Enter your phone number">
<br><br>
<button onclick="track()">Track Order</button>

<div id="result" style="margin-top:20px;font-size:18px;"></div>
<div id="map" style="height:400px; width:90%; margin:20px auto; border-radius:12px;"></div>
</div>


<script>

    // ===== MAP SETUP =====
let map;
let marker;

function initMap(){
    map = L.map('map').setView([17.3850, 78.4867], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    marker = L.marker([17.3850, 78.4867]).addTo(map);
}

initMap();

// autofill phone if already tracked
window.onload = function(){
    const saved = localStorage.getItem("track_phone");
    if(saved){
        document.getElementById("phone").value = saved;
        track();
    }
};

// ===== TRACK FUNCTION =====

async function track(){

let phone = document.getElementById("phone").value;

// if first time user enters
if(phone){
    localStorage.setItem("track_phone", phone);
}
// if auto refresh
else{
    phone = localStorage.getItem("track_phone");
}

// still empty ‚Üí do nothing
if(!phone){
    return;
}

const res=await fetch("/track-order/"+phone);
const data=await res.json();

const result=document.getElementById("result");

if(data.found){

    let html = "<h3>Your Orders</h3>";

    data.orders.forEach(order=>{

        let message="";

        if(order.status==="PENDING")
            message="üü° Waiting for payment verification";

        else if(order.status==="CONFIRMED")
            message="üü¢ Preparing your food";

        else if(order.status==="Ready")
            message="üë®‚Äçüç≥ Order ready";

        else if(order.status==="Out for Delivery")
            message="üö¥ Out for delivery";

        else if(order.status==="Delivered")
            message="‚úÖ Delivered";

        html += `
        <div style="border:1px solid #ddd;padding:12px;margin:10px;border-radius:10px;background:white;">
        <b>Order #${order.id}</b><br>
        ${order.food_item}<br>
        Status: ${message}
        </div>
        `;
    });

    result.innerHTML = html;

    // ===== MOVE MAP USING LATEST ORDER =====
    if(data.latest && data.latest.delivery_lat && data.latest.delivery_lng){

        const newPosition = [
            data.latest.delivery_lat,
            data.latest.delivery_lng
        ];

        marker.setLatLng(newPosition);
        map.setView(newPosition, 15);
    }

}else{
    result.innerHTML="No orders found";
}

}

if(!window.trackingStarted){
    window.trackingStarted = true;
    setInterval(track,5000);
}

</script>

</body>
</html>
